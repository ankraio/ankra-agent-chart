name: Build and Push to Harbor

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Install ORAS
        run: |
          curl -LO https://github.com/oras-project/oras/releases/download/v1.1.0/oras_1.1.0_linux_amd64.tar.gz
          tar -xzf oras_1.1.0_linux_amd64.tar.gz
          sudo mv oras /usr/local/bin/
          oras version

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="$(grep '^version:' chart/Chart.yaml | awk '{print $2}')"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Chart version: $VERSION"

      - name: Update Chart.yaml with version
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "Updating Chart.yaml with version: $VERSION"
          sed -i "s/^version:.*/version: $VERSION/" chart/Chart.yaml
          sed -i "s/^appVersion:.*/appVersion: $VERSION/" chart/Chart.yaml
          echo "Updated Chart.yaml:"
          grep -E '^(version|appVersion):' chart/Chart.yaml

      - name: Commit Chart.yaml changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add chart/Chart.yaml
          git commit -m "chore: update Chart.yaml to version ${{ steps.version.outputs.version }}" || echo "No changes to commit"
          git push origin HEAD:main

      - name: Validate Harbor credentials
        env:
          HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          if [ -z "$HARBOR_USERNAME" ]; then
            echo "Error: HARBOR_USERNAME secret is not set"
            exit 1
          fi
          if [ -z "$HARBOR_PASSWORD" ]; then
            echo "Error: HARBOR_PASSWORD secret is not set"
            exit 1
          fi
          echo "Harbor credentials validated"

      - name: Package Helm Chart
        run: |
          helm package chart/ --version ${{ steps.version.outputs.version }}
          echo "Verifying README.md is in the package:"
          tar -tzf ankra-agent-${{ steps.version.outputs.version }}.tgz | grep README.md || echo "WARNING: README.md not found in package"

      - name: Login to Harbor
        env:
          HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          echo "Attempting to login to registry.ankra.cloud as user: $HARBOR_USERNAME"
          echo "$HARBOR_PASSWORD" | helm registry login registry.ankra.cloud \
            --username "$HARBOR_USERNAME" \
            --password-stdin
          if [ $? -eq 0 ]; then
            echo "Successfully logged in to Harbor registry"
          else
            echo "Failed to login to Harbor registry"
            exit 1
          fi

      - name: Push Chart to Harbor
        run: |
          echo "Pushing chart: ankra-agent-${{ steps.version.outputs.version }}.tgz"
          helm push ankra-agent-${{ steps.version.outputs.version }}.tgz oci://registry.ankra.cloud/ankra
          if [ $? -eq 0 ]; then
            echo "Successfully pushed chart to Harbor"
          else
            echo "Failed to push chart to Harbor"
            exit 1
          fi

      - name: Attach README to Harbor artifact
        env:
          HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          echo "Logging in to Harbor with ORAS"
          echo "$HARBOR_PASSWORD" | oras login registry.ankra.cloud \
            --username "$HARBOR_USERNAME" \
            --password-stdin
          
          echo "Attaching README.md to chart artifact"
          oras attach \
            --artifact-type application/vnd.cncf.helm.config.v1+json \
            --annotation "org.opencontainers.image.description=Kubernetes agent for seamless cluster integration, monitoring, and automation with the Ankra platform" \
            registry.ankra.cloud/ankra/ankra-agent:${{ steps.version.outputs.version }} \
            chart/README.md:application/markdown
          
          if [ $? -eq 0 ]; then
            echo "Successfully attached README to Harbor artifact"
          else
            echo "Warning: Failed to attach README, but chart was pushed successfully"
          fi

      - name: Logout from Harbor
        if: always()
        run: |
          helm registry logout registry.ankra.cloud
