name: Build and Push to Harbor

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.0

      - name: Extract version from tag
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="$(grep '^version:' chart/Chart.yaml | awk '{print $2}')"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Chart version: $VERSION"

      - name: Validate Harbor credentials
        env:
          HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          if [ -z "$HARBOR_USERNAME" ]; then
            echo "Error: HARBOR_USERNAME secret is not set"
            exit 1
          fi
          if [ -z "$HARBOR_PASSWORD" ]; then
            echo "Error: HARBOR_PASSWORD secret is not set"
            exit 1
          fi
          echo "Harbor credentials validated"

      - name: Package Helm Chart
        run: |
          helm package chart/ --version ${{ steps.version.outputs.version }}

      - name: Login to Harbor
        env:
          HARBOR_USERNAME: ${{ secrets.HARBOR_USERNAME }}
          HARBOR_PASSWORD: ${{ secrets.HARBOR_PASSWORD }}
        run: |
          echo "Attempting to login to registry.ankra.cloud as user: $HARBOR_USERNAME"
          echo "$HARBOR_PASSWORD" | helm registry login registry.ankra.cloud \
            --username "$HARBOR_USERNAME" \
            --password-stdin
          if [ $? -eq 0 ]; then
            echo "Successfully logged in to Harbor registry"
          else
            echo "Failed to login to Harbor registry"
            exit 1
          fi

      - name: Push Chart to Harbor
        run: |
          echo "Pushing chart: ankra-agent-${{ steps.version.outputs.version }}.tgz"
          helm push ankra-agent-${{ steps.version.outputs.version }}.tgz oci://registry.ankra.cloud/ankra
          if [ $? -eq 0 ]; then
            echo "Successfully pushed chart to Harbor"
          else
            echo "Failed to push chart to Harbor"
            exit 1
          fi

      - name: Logout from Harbor
        if: always()
        run: |
          helm registry logout registry.ankra.cloud
